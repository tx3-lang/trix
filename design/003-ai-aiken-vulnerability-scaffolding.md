# AI Aiken Vulnerability Scaffolding

## Overview

This document defines the **Milestone 1 scaffolding** for an AI-assisted Aiken vulnerability analysis command in Trix.

Scope for this milestone is intentionally limited to:
- CLI wiring for a new scoped command: `trix aiken`
- Contracts for iterative skill-by-skill analysis state (JSON)
- Contracts for permission prompt generation and final vulnerability report generation
- Local-first execution boundaries and security assumptions
- C4 architecture diagrams in PlantUML

Out of scope for this milestone:
- Real LLM integration implementation
- Actual command execution orchestration against an AI provider
- Deep prompt engineering and remediation automation

## Goals

1. Establish a stable command surface for future implementation.
2. Define the analysis loop model that processes vulnerability skills one by one.
3. Persist progress incrementally in JSON after each skill iteration.
4. Produce a final vulnerability document contract (Markdown output path + structure).
5. Define a local command permission prompt contract (e.g. `grep`, `cat`) for constrained auto-execution.

## CLI Surface (Scaffolding)

`trix aiken` is a **scoped** command and requires a project context (`trix.toml`).

**⚠️  EXPERIMENTAL**: This command requires the `unstable` feature to be enabled. Build with:
```bash
cargo build --features unstable
```

### Command Structure

The command follows a subcommand pattern for extensibility:

```bash
trix aiken <subcommand> [options]
```

### Available Subcommands (Milestone 1)

#### `trix aiken audit`

Audits Aiken code for vulnerabilities using AI-assisted detection.

**Arguments:**
- `--state-out` (default: `.tx3/aiken-audit/state.json`) - Path where the incremental analysis state JSON will be written
- `--report-out` (default: `.tx3/aiken-audit/vulnerabilities.md`) - Path where the final vulnerability report markdown will be written
- `--skills-dir` (default: `skills/vulnerabilities`) - Path to vulnerability skill definitions

**Example:**
```bash
trix aiken audit
trix aiken audit --state-out ./custom/state.json
```

## Skill-by-skill Loop Contract

The analysis process is modeled as an iterative loop:

1. Load one vulnerability skill definition.
2. Build a focused mini-prompt for that single skill.
3. Execute analysis (future milestone, provider-backed).
4. Append iteration result to JSON state.
5. Continue with next skill until all skills are processed.
6. Render final vulnerability report document from aggregate findings.

This loop enables narrow prompts per skill, improving precision and traceability.

## State and Output Contracts

### Incremental JSON state

Defined by `AnalysisStateJson` and related structures in:
- `src/commands/aiken/model.rs`

Key sections:
- Target metadata and provider spec
- Permission prompt spec (allowed local commands, scope rules)
- Ordered list of `SkillIterationResult`

### Final report

Defined by `VulnerabilityReportSpec` and a Markdown template scaffold:
- `templates/aiken/report.md`

### Permission prompt

Template scaffold:
- `templates/aiken/permission_prompt.md`

This prompt is intended to grant **explicit, bounded, local** command execution rights to the analysis agent.

## External AI Service Note

Future milestones may integrate external AI services (for example, **Anthropic**) behind a provider adapter boundary.

For this milestone, provider integration is represented as a contract only (`ProviderSpec`) and no network behavior is implemented.

## Local Execution and Safety Boundaries

The architecture assumes:
- Analysis runs locally from the developer machine.
- Only an allowlist of read-oriented commands is permitted by policy prompt (e.g. `grep`, `cat`, `find`, `ls`).
- Writes are limited to designated output artifacts (state JSON and report document).
- Scope rules constrain path access to project roots.

## C4 Architecture Diagrams

C4 diagrams are maintained as separate PlantUML files in [`003-assets/`](003-assets/) for easier image generation and version control.

### Generating Diagrams

To generate PNG/SVG images from PlantUML source:

```bash
# Using PlantUML CLI
plantuml design/003-assets/*.puml

# Or using Docker
docker run --rm -v $(pwd)/design/003-assets:/data plantuml/plantuml:latest *.puml
```

### C4 - Context Diagram

**Source:** [c4-context.puml](003-assets/c4-context.puml)

![C4 Context Diagram](https://www.plantuml.com/plantuml/svg/LP71SXen343l-nKg9peDxA4vfPSmj9b9XpGCQNibnXP1nMjx97c1lw-zcsc7qwxifoTBkXSrhBdpiBpTBcDGFEjsGKSClxCFpGSArcU7S51DSjUsR4xpDz93tcL1jZKXwDp6hatUX2gQYJfFktPvErlNerzFgxOpeiZj_nBpLCYcMIDB35E7_GrClcAFFYRaIGasEGZyP3e31J3WepKU4iS_Q7NoiNcv564trG8KUE2MgyT9_Jz_XcJiqRmXT2QK3__Zjz_EEZLKgFA378foyGXhZZsviUnpKehrV9yrCq9wlmF9zW16O17qm36HlPRkfIIlXaS-a4SOhwfnFRuP96QsU0Do9EyB7REch58qpGRzE8AndR7trng0gPi0antfQq4hEK93mGqQ9s2ZG_W4VTaNijcH9xsyb_a29oP5WUylppz0r2Y22GwU31zTF0LWJ97roZpCvs5e_mu4WvDHDfE4blPawr2wf3AO62rIZpKm_Y8qD7HVikf-_m80)

*System context showing developer interaction with Trix CLI, local filesystem, and future external AI provider integration.*

### C4 - Container Diagram

**Source:** [c4-container.puml](003-assets/c4-container.puml)

![C4 Container Diagram](https://www.plantuml.com/plantuml/svg/RLHDKnin3Btlhr1p2jD2Bfmu4LAOIIUqJA3jaN5sHT34QxkM7CXq-jyhhzbj4dg9hG-z9yalUybYegJMmkpySUQT678O7wUqGVSZMLTz85VRr20yYmI-c4oYUJbRapodLMACjPQWaxFQjvDWZSjGfooDfTLaTdvwbrtVRnUJrh1WdEoJd0NDhQexZEpTkC7j9nXznYrQ7p2EJghxdPQqZrS-kSR4tLWYlMhAWnumMyn79_2x0XZWnhKb3NUTmpGr91fhM-EQaRgNYGK-mioQa4sjXxf40Pt4NV3a1B9fuZgrgCQpMfRSMblPfx7U1qMutv2ri503hjrQ8prBFkU2qGWoR7M5UbsH9Ta1vnhkM59ekWGMFOuOGlHj48MvovTkZE0PuzuS3zW6cm6oxogHRHXQSdHQQWj7mDWICta7nNt4qt7dKV89FoF90SUN-szVivaVY5WnLGaHysgCLNnZTqp_7o1Yy54oKdTv3trhugRnB-vm3XstIJKoF96Y7-skOBxVr9OQZAMukyAqCK7q7DyaIH5F1bg9XWHMRtBAxkcArLaB0xvgIIQTpe4nRgdEC_sfUX5UlyhuYRLauMlDkY6BK4AQjfTZiWIlzy3wjePsDBzQeYrwBvATkwtV86ia1pfVBp8nCJzcLlDRk4G6YIpnLq8MBjewqC11mR-tzX4Pg1DeLePQoHubbrqFoYhlaNyRScikuUD-XeSeSrw0uOrM-ZX8fHJqgkkssGdZJKD5RoMdC1mcjRrc3kYxMVlC9PgctyGJMIn_0-arrfSClHeQ-WM7ykBZ1lHvRSwiBj4r-GFr5m00)

*Container-level view of Trix CLI internals: command entrypoint, skill loop engine, prompt composer, state/report writers, and provider adapter boundary.*

### C4 - Component Diagram

**Source:** [c4-component.puml](003-assets/c4-component.puml)

![C4 Component Diagram](https://www.plantuml.com/plantuml/svg/TPFFRjim3CRlVWekfnPhuqjFFJNDQKMp1Issgw58J29KVpIAQXeCU_T9jc4dNdeBANw_Zo7fXyY2E5a3oxjcwMtm3Xqt2_s6xbSohlgYdJH98UoPGxolQnA7-KxpFcrIH9BUSHRCfRTrCC8Lr6raPVIcNjxThalgv-gvjY8oKdrgCW-vjggMcI2qGseUVN9AqF5A5FSRcBLTm28fpP1bLZW5Aw-ImTar_Aa01jQLj2eBABahGRju0xclhTxTG22_rGQlP_dLUZMdM7wzIXzGWUoP6K37uBNZsVKPDRvfOnhZXK8giXB2SniMp3Pn8WJRjPGJvIb2ri9xCWv9RBJHV8IM0u9106kB4nUhdMu2vPWpOvKZMBSHF2PjFlDgto9ilKmH5NJw71B8H9IvdUl4Ao1P7QFsRdHS3xaBlems6C48PTCa99zu6o-56QOueljcfiFaZ6ciLsZAB4i4gnBrkq7JRsVXX3b67TkIfvXvNq4pak3C7lg85_6HFU60VotHnUcze52nFb3cHj1E4jeC4GQUNdzyXvOruHC6JzmGEeM4L1Xj1bxwpAVJwWhYv2Qie3Vb3sww8FBlEfStGed0hS-wJy6YfCxE8NjexcR6U_91ozhp7Wbw385sZBj-T9l-0ykMVwlg1KttsKokdF1tmiWH77wCHpHKdr_hfhk4W7JRLewh7mJJanjbNKEe03zGfjBY1VdvsQI8SJo1QTsu_smQTVaJAEGUZFTXFA5JrVzRfNvRM-s4wTzF5TC53Skux_y6mk8RI65CQQzwoBXaJVKF)

*Component-level detail of the Aiken command module: skill loader, prompt builders, state model, storage, report renderer, and provider adapter.*

## Skills Source Convention

Vulnerability skills live under:
- `skills/vulnerabilities/`

One file per skill, designed for 1:1 loop processing.

Suggested frontmatter-like fields per file:
- `id`
- `title`
- `severity`
- `description`
- `prompt_fragment`

## Milestone 1 Acceptance Criteria

- `trix aiken` command exists as a scoped command with subcommand structure.
- Command is gated behind `unstable` feature flag (following `publish` pattern).
- `trix aiken audit` subcommand is implemented as scaffold.
- `src/commands/aiken/mod.rs` routes subcommands following the `profile` pattern.
- `src/commands/aiken/audit.rs` contains the audit scaffold implementation.
- `src/commands/aiken/model.rs` defines scaffolding contracts for state, findings, and prompts.
- Templates for report and permission prompt exist in `templates/aiken/`.
- `skills/vulnerabilities/` exists with seed skill files.
- This design document includes C4 diagrams as separate PlantUML files in `003-assets/`.
- E2E scaffold tests verify command visibility and baseline behavior for `audit` subcommand (tests run with `--features unstable`).
